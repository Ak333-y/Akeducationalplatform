<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>学習時間管理 - StudyBase</title>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #001d6e, #003c8f);
      color: white;
      min-height: 100vh;
    }

   .navbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(90deg, #000814, #001d6e); /* 夜空みたいな深い青 */
  color: white;
  padding: 10px 40px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5); /* 影をちょい強め */
}

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 26px;
      font-weight: bold;
    }

    .logo img {
      height: 50px;
    }

    .menu {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .menu a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      transition: 0.2s;
    }

    .menu a:hover {
      color: #93c5fd;
    }

    .logout button {
      background: #b91c1c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      transition: 0.18s;
    }

    .logout button:hover {
      background: #991b1b;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.30);
      transform: translateY(-1px);
    }

    .main {
      display: flex;
      gap: 40px;
      padding: 40px;
      align-items: flex-start;
    }

    .left, .right {
      flex: 1;
      background: rgba(255, 255, 255, 0.9);
      color: black;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .form-section {
      margin-bottom: 20px;
    }

    select, input, button {
      padding: 8px;
      font-size: 16px;
      margin-right: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #1e40af;
    }

    h2 {
      margin-top: 0;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      font-size: 18px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="logo">
      <img src="logo.png" alt="StudyBase ロゴ">
      StudyBase — Your Daily Step to Success.
    </div>
    <div class="menu">
      <a href="menu.html">ホーム</a>
      <a href="select.html">テスト</a>
      <a href="history.html">過去の成績</a>
      <a href="add_question.html">問題編集</a>
      <a href="study_time.html">学習時間</a>
      <div class="logout">
        <button onclick="logout()">ログアウト</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="left">
      <h2>📊 学習時間グラフ</h2>
      <canvas id="studyChart"></canvas>
    </div>
    <div class="right">
      <h2>⏱ 学習時間を追加</h2>
      <div class="form-section">
        <select id="subject">
          <option value="国語">国語</option>
          <option value="数学">数学</option>
          <option value="英語">英語</option>
          <option value="理科">理科</option>
          <option value="社会">社会</option>
        </select>
        <input type="number" id="minutes" placeholder="時間（分）" min="1" />
        <button onclick="addStudyTime()">追加</button>
      </div>
      <h3>📘 教科別合計時間</h3>
      <ul id="totalList"></ul>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCYILTR11999wsK7zoFV2rfQkgneumhsvk",
      authDomain: "akeducationalplatform.firebaseapp.com",
      projectId: "akeducationalplatform",
      storageBucket: "akeducationalplatform.firebasestorage.app",
      messagingSenderId: "778140595189",
      appId: "1:778140595189:web:301e7490b813b44782a6bc"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth();
    const db = firebase.getFirestore();

    const ctx = document.getElementById('studyChart').getContext('2d');
    let chart;

    firebase.onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        loadData(user.uid);
      }
    });

    async function addStudyTime() {
      const user = auth.currentUser;
      if (!user) return;
      const subject = document.getElementById("subject").value;
      const minutes = parseInt(document.getElementById("minutes").value);
      const date = new Date().toISOString().split('T')[0];

      if (!minutes || minutes <= 0) return alert("時間を入力してね！");

      await firebase.addDoc(firebase.collection(db, "study_times"), {
        uid: user.uid,
        subject,
        minutes,
        date,
      });
      alert("保存完了！");
      loadData(user.uid);
    }

    async function loadData(uid) {
      const q = firebase.query(firebase.collection(db, "study_times"), firebase.where("uid", "==", uid));
      const snapshot = await firebase.getDocs(q);
      const data = {};
      const totals = { 国語: 0, 数学: 0, 英語: 0, 理科: 0, 社会: 0 };

      snapshot.forEach(doc => {
        const d = doc.data();
        if (!data[d.date]) data[d.date] = { 国語: 0, 数学: 0, 英語: 0, 理科: 0, 社会: 0 };
        data[d.date][d.subject] += d.minutes;
        totals[d.subject] += d.minutes;
      });

      updateChart(data);
      updateTotals(totals);
    }

    function updateChart(data) {
      const dates = Object.keys(data).sort();
      const subjects = ["国語", "数学", "英語", "理科", "社会"];
      const colors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6"];

      const datasets = subjects.map((sub, i) => ({
        label: sub,
        data: dates.map(d => data[d][sub]),
        backgroundColor: colors[i],
      }));

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: dates, datasets },
        options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
      });
    }

    function updateTotals(totals) {
      const ul = document.getElementById("totalList");
      ul.innerHTML = "";
      for (const [sub, time] of Object.entries(totals)) {
        ul.innerHTML += `<li>${sub}: ${time}分</li>`;
      }
    }

    function logout() {
      firebase.signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
