<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>テスト - StudyBase</title>

  <style>
    body {
      margin: 0;
      font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background-color: #f3f5f7;
    }

    /* 上バー */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #000814, #001d6e);
      color: white;
      padding: 10px 40px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: bold;
    }
    .logo img { height: 40px; }
    .menu {
      display: flex;
      align-items: center;
      gap: 25px;
      flex-wrap: wrap;
    }
    .menu a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 15px;
      transition: 0.2s;
      pointer-events: none; /* テスト中は無効化 */
      opacity: 0.4;
    }
    .menu a:hover { color: #93c5fd; }
    .logout button {
      background: #b91c1c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .logout button:hover {
      background: #991b1b;
    }

    /* メイン部分 */
    .main {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .question {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .choices button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 2px solid #001d6e;
      background: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .choices button:hover {
      background: #e5ecff;
    }

    .input-answer {
      font-size: 18px;
      padding: 6px 10px;
      width: 60%;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .btn {
      margin-top: 20px;
      background: #001d6e;
      color: white;
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .sortable-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .sortable-item {
      background: #e5ecff;
      border: 1px solid #001d6e;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="logo">
      <img src="logo.png" alt="StudyBase ロゴ">
      StudyBase — Your Daily Step to Success.
    </div>
    <div class="menu">
      <a href="menu.html">ホーム</a>
      <a href="select.html">テスト</a>
      <a href="history.html">過去の成績</a>
      <a href="add_question.html">問題編集</a>
      <div class="logout"><button id="endTest">テスト中断</button></div>
    </div>
  </div>

  <div class="main">
    <div id="questionBox"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYILTR11999wsK7zoFV2rfQkgneumhsvk",
      authDomain: "akeducationalplatform.firebaseapp.com",
      projectId: "akeducationalplatform",
      storageBucket: "akeducationalplatform.firebasestorage.app",
      messagingSenderId: "778140595189",
      appId: "1:778140595189:web:301e7490b813b44782a6bc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const subject = sessionStorage.getItem("selectedSubject");
    const questionBox = document.getElementById("questionBox");

    let questions = [];
    let currentIndex = 0;
    let correctCount = 0;

    async function loadQuestions() {
      const querySnapshot = await getDocs(collection(db, "questions"));
      questions = querySnapshot.docs
        .map(doc => doc.data())
        .filter(q => q.subject === subject);

      if (questions.length === 0) {
        questionBox.innerHTML = "<p>この教科には問題がありません。</p>";
        return;
      }
      showQuestion();
    }

    function showQuestion() {
      const q = questions[currentIndex];
      questionBox.innerHTML = `<div class="question">${q.question}</div>`;

      if (q.type === "四択") {
        const choicesHTML = q.choices.map(choice => `
          <button onclick="checkAnswer('${choice}', '${q.answer}')">${choice}</button>
        `).join("");
        questionBox.innerHTML += `<div class="choices">${choicesHTML}</div>`;
      } 
      else if (q.type === "一問一答") {
        questionBox.innerHTML += `
          <input id="userAnswer" class="input-answer" placeholder="答えを入力" />
          <br>
          <button class="btn" onclick="showAnswer('${q.answer}')">答えを見る</button>
        `;
      } 
      else if (q.type === "並び替え") {
        const parts = q.sentence.split(" ");
        const listHTML = parts.map(p => `<div class="sortable-item">${p}</div>`).join("");
        questionBox.innerHTML += `
          <div class="sortable-list" id="sortableList">${listHTML}</div>
          <button class="btn" onclick="checkOrder('${q.answer}')">採点</button>
        `;
        makeSortable();
      }
    }

    window.checkAnswer = function(selected, correct) {
      if (selected === correct) correctCount++;
      nextQuestion();
    }

    window.showAnswer = function(answer) {
      const input = document.getElementById("userAnswer").value.trim();
      const result = input === answer ? "正解！" : `不正解…　正解：${answer}`;
      if (input === answer) correctCount++;
      questionBox.innerHTML += `<p>${result}</p><button class="btn" onclick="nextQuestion()">次へ</button>`;
    }

    window.checkOrder = function(answer) {
      const items = [...document.querySelectorAll(".sortable-item")].map(i => i.textContent.trim());
      const userAnswer = items.join(" ");
      const result = userAnswer === answer ? "正解！" : `不正解…　正解：${answer}`;
      if (userAnswer === answer) correctCount++;
      questionBox.innerHTML += `<p>${result}</p><button class="btn" onclick="nextQuestion()">次へ</button>`;
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex >= questions.length) {
        const rate = Math.round((correctCount / questions.length) * 100);
        questionBox.innerHTML = `
          <h2>テスト終了！</h2>
          <p>正答数：${correctCount}/${questions.length}</p>
          <p>正答率：${rate}%</p>
          <button class="btn" onclick="location.href='menu.html'">メニューに戻る</button>
        `;
      } else {
        showQuestion();
      }
    }

    function makeSortable() {
      const list = document.getElementById("sortableList");
      let dragged;
      list.addEventListener("dragstart", e => {
        dragged = e.target;
        e.target.style.opacity = 0.5;
      });
      list.addEventListener("dragend", e => {
        e.target.style.opacity = "";
      });
      list.addEventListener("dragover", e => {
        e.preventDefault();
      });
      list.addEventListener("drop", e => {
        e.preventDefault();
        if (e.target.classList.contains("sortable-item")) {
          const temp = dragged.textContent;
          dragged.textContent = e.target.textContent;
          e.target.textContent = temp;
        }
      });
      document.querySelectorAll(".sortable-item").forEach(i => i.setAttribute("draggable", "true"));
    }

    document.getElementById("endTest").onclick = () => {
      if (confirm("テストを中断しますか？")) location.href = "menu.html";
    };

    loadQuestions();
  </script>
</body>
</html>
